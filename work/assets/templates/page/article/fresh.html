{{template "share" .}}

{{define "css"}}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<style>
    /* ------------------------------------------- */
    /* 主介面 - 文字顯示區樣式 */
    /* ------------------------------------------- */
    #displaySelected {
        border: 1px solid #ced4da;
        padding: .375rem .75rem;
        background-color: #e9ecef;
        /* 淺灰色背景 */
        min-width: 150px;
        border-radius: .25rem;
        color: #495057;
        font-weight: bold;
        flex-shrink: 0;
    }
    /* 確保 Modal 內容區有足夠的內距 */
    .modal-body {
        padding: 1.5rem;
    }
</style>
{{end}}

{{define "content"}}
{{/** 標題欄位 */}}
<div class="mb-3">
    <input type="text" class="form-control" id="articleTitle" placeholder="{{.ArticleTitle}}">
</div>

{{/** 節點選擇按鈕 */}}
<div class="d-flex align-items-center gap-2 mb-3">
    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#nodeModal">挑選節點</button>
    <span id="displaySelected">尚未挑選</span>
</div>

{{/** Quill 編輯器 */}}
<div class="mb-3">
    <div id="editor" style="height: 600px;"></div>
</div>

{{/** 送出按鈕 */}}
<button class="btn btn-success" onclick="submit()">送出</button>

{{/** 節點選擇 Modal */}}
<div class="modal fade" id="nodeModal" tabindex="-1" aria-hidden="true" onclick="onBlur(event)">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">請選擇節點</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex flex-wrap gap-2">
                    {{range .NodeMap}}
                    <button class="btn btn-outline-info" onclick="select_node('{{.NodeID}}', '{{.PathName}}')">{{.Path}}</button>
                    {{end}}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="onBlur(event)">關閉 Panel</button>
            </div>
        </div>
    </div>
</div>
{{end}}

{{define "js"}}
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script>
    let node_id = null;
    let node_name = null;
    function select_node(id, name) {
        node_id = id;
        node_name = name;
        document.getElementById("displaySelected").textContent = name;
        bootstrap.Modal.getInstance(document.getElementById("nodeModal")).hide();
    }
</script>

<script>
    const quill = new Quill('#editor', {
        theme: 'snow',
        placeholder: "請輸入文章內容...",
        modules: {
            toolbar: [
                [{ font: [] }, { size: ['small', false, 'large', 'huge'] }],
                [{ color: [] }, { background: [] }],
                ['bold', 'italic', 'underline'],
                [{ list: 'ordered' }, { list: 'bullet' }],
                ['link', 'image'],
                ['clean']
            ]
        }
    });

    function onBlur(event){
        $(event.target).blur();
    }

    function submit() {
        const title = document.getElementById("articleTitle").value.trim();

        if (!title) return alert("請輸入文章標題！");
        if (!node_id) return alert("請選擇節點！");
        if (!quill.root.innerText) return alert("請輸入文章內容！");

        const params = {
            node_id: node_id,
            title: title,
            content: quill.root.innerHTML
        };

        $.ajax({
            url: "/api/v1/article/add",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(params),
            success: function (response) {
                if(response.Code == "OK"){
                    alert("增加文章成功！");
                    location.reload();
                    return;
                }
                alert("增加文章失敗", response.Code);
            },
            error: function (xhr, status, error) {
                console.error("增加文章失敗：", error);
                alert("增加文章失敗，請稍後再試！");
            }
        });
    }
</script>
{{end}}
