{{template "share" .}}

{{define "css"}}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<style>
  .ql-font-arial { font-family: Arial, sans-serif; }
  .ql-font-helvetica { font-family: Helvetica, sans-serif; }
  .ql-font-georgia { font-family: Georgia, serif; }
  .ql-font-courier { font-family: "Courier New", monospace; }
  .ql-font-jhenghei { font-family: "Microsoft JhengHei", sans-serif; }
  .ql-font-noto { font-family: "Noto Sans TC", sans-serif; }
</style>
<style>
    /* ------------------------------------------- */
    /* 主介面 - 文字顯示區樣式 */
    /* ------------------------------------------- */
    #displaySelected {
        border: 1px solid #ced4da;
        padding: .375rem .75rem;
        background-color: #e9ecef;
        /* 淺灰色背景 */
        min-width: 150px;
        border-radius: .25rem;
        color: #495057;
        font-weight: bold;
        flex-shrink: 0;
    }
    /* 確保 Modal 內容區有足夠的內距 */
    .modal-body {
        padding: 1.5rem;
    }
</style>
{{end}}

{{define "content"}}
<!-- 標題欄位 -->
<div class="mb-3">
    <input type="text" class="form-control" id="articleTitle" placeholder="請輸入文章標題">
</div>

<!-- 節點選擇按鈕 -->
<div class="d-flex align-items-center gap-2 mb-3">
    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#nodeModal">挑選節點</button>
    <span id="displaySelected">尚未挑選</span>
</div>

<!-- Quill 編輯器 -->
<div class="mb-3">
    <div id="editor" style="height: 600px;"></div>
</div>

<!-- 送出按鈕 -->
<button class="btn btn-success" onclick="submitArticle()">送出文章</button>

<!-- 節點選擇 Modal -->
<div class="modal fade" id="nodeModal" tabindex="-1" aria-hidden="true" onclick="onBlur(event)">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">請選擇節點</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex flex-wrap gap-2">
                    {{range .NodeMap}}
                    <button class="btn btn-outline-info" onclick="selectNode('{{.NodeID}}', '{{.PathName}}')">{{.Path}}</button>
                    {{end}}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="onBlur(event)">關閉 Panel</button>
            </div>
        </div>
    </div>
</div>
{{end}}

{{define "js"}}
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script>
    function onBlur(event){
        $(event.target).blur();
    }
    const Font = Quill.import('formats/font');
    Font.whitelist = ['arial', 'helvetica', 'georgia', 'courier', 'jhenghei', 'noto'];
    Quill.register(Font, true);

    const quill = new Quill('#editor', {
        theme: 'snow',
        modules: {
        toolbar: [
            [{ font: Font.whitelist }, { size: ['small', false, 'large', 'huge'] }],
            [{ color: [] }, { background: [] }],
            ['bold', 'italic', 'underline'],
            [{ list: 'ordered' }, { list: 'bullet' }],
            ['link', 'image'],
            ['clean']
        ]
        },
        placeholder: '請輸入文章內容...'
    });

    let selectedNodeId = null;
    function selectNode(id, name) {
        selectedNodeId = id;
        document.getElementById("displaySelected").textContent = name;
        bootstrap.Modal.getInstance(document.getElementById("nodeModal")).hide();
    }

    function submitArticle() {
        const title = document.getElementById("articleTitle").value.trim();
        const contentHtml = quill.root.innerHTML;

        if (!title) return alert("請輸入文章標題！");
        if (!selectedNodeId) return alert("請選擇節點！");
        if (!contentHtml || contentHtml === "<p><br></p>") return alert("請輸入文章內容！");

        const payload = {
            title: title,
            content: contentHtml,
            node_id: selectedNodeId
        };

        fetch("/api/v1/article/create", {
            method: "POST",
            headers: {
            "Content-Type": "application/json"
            },
            body: JSON.stringify(payload)
        }).then(res => {
            if (res.ok) {
            alert("文章已送出！");
            location.reload();
            } else {
            alert("送出失敗！");
            }
        });
    }
</script>
{{end}}
