{{template "share" .}}

{{define "css"}}
<style>
    /* ------------------------------------------- */
    /* 主介面 - 文字顯示區樣式 */
    /* ------------------------------------------- */
    #displaySelected {
        border: 1px solid #ced4da;
        padding: .375rem .75rem;
        background-color: #e9ecef;
        /* 淺灰色背景 */
        min-width: 150px;
        border-radius: .25rem;
        color: #495057;
        font-weight: bold;
        flex-shrink: 0;
    }

    /* ------------------------------------------- */
    /* 彈跳 Panel 樣式                              */
    /* ------------------------------------------- */
    .big-square-button {
        width: 80px;
        /* 寬度 80px */
        height: 80px;
        /* 高度 80px */

        /* 使用 Flexbox 確保內容在按鈕內垂直和水平置中 */
        display: flex;
        align-items: center;
        justify-content: center;

        font-size: 1.1rem;
        font-weight: bold;
        text-align: center;
        white-space: normal;
        /* 允許文字換行 */
    }

    /* 確保 Modal 內容區有足夠的內距 */
    .modal-body {
        padding: 1.5rem;
    }
</style>
{{end}}

{{ define "list" }}
<button type="button" class="btn btn-outline-info big-square-button" onclick="select_node(event,'Root','{{.RootID}}')">Root</button>
    {{ range .NodeMap }}
    <button type="button" class="btn btn-outline-info big-square-button" onclick="select_node(event,'{{.PathName}}','{{.NodeID}}')">{{.PathName}}</button>
    {{ end }}
{{end}}

{{ define "category" }}
<ul class="list-group">
    {{ range . }}
    <li class="list-group-item">
        <div class="d-flex justify-content-between align-items-center">
            <span>
                {{ if .Children }}
                    <span data-bs-toggle="collapse" data-bs-target="#node-{{.NodeID}}" style="cursor:pointer;">
                        ⊞ {{ .PathName }}
                    </span>
                {{ else }}
                    ⊟ {{ .PathName }}
                {{ end }}
            </span>
            <button class="btn btn-sm btn-outline-danger" onclick="del_node('{{.NodeID}}')">刪除</button>
        </div>

        {{ if .Children }}
        <div class="collapse show mt-2 ms-3" id="node-{{.NodeID}}">
            {{ template "category" .Children }}
        </div>
        {{ end }}
    </li>
    {{ end }}
</ul>
{{ end }}

{{define "content"}}
<div class="container mt-5">
    <h2>增加節點</h2>
    <div class="d-flex align-items-center gap-2 mb-4">
        <button type="button" class="btn btn-primary flex-shrink-0" data-bs-toggle="modal"
            data-bs-target="#panelModal">挑選父節點</button>
        <span id="displaySelected">尚未挑選父節點</span> <input type="text" class="form-control" id="mainTextInput"
            placeholder="輸入節點名稱">
        <button type="button" class="btn btn-success flex-shrink-0" onclick="add_node();">增加節點</button>
    </div>
</div>
<div class="container mt-5">
    {{ template "category" .List }}
</div>
<div class="modal fade" id="panelModal" tabindex="-1" aria-labelledby="panelModalLabel" aria-hidden="true" onclick="onBlur(event)">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="panelModalLabel">請選擇一個節點</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex flex-wrap gap-3 justify-content-center" id="modalButtonsContainer">
                    {{template "list" .}}
                </div>
                <hr class="mt-4">
                <p class="text-center text-muted">點擊上方的按鈕，會將其值填入主畫面的顯示區。</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="onBlur(event)">關閉 Panel</button>
            </div>
        </div>
    </div>
</div>
{{end}}

{{define "js"}}
<script>
    function onBlur(event){
        $(event.target).blur();
    }

    var node_id ;
    function add_node(){
        if (node_id == undefined || node_id.length == 0) {
            alert("請先點擊「挑選父節點」按鈕，選擇一個父節點！");
            return;
        }
        const node_name = $("#mainTextInput").val();
        if (node_name.trim() === "") {
            alert("請輸入新的節點名稱！");
            return;
        }

        const params = {
            id: node_id,
            label: node_name
        };
        $.ajax({
            url: "/api/v1/node/add", // 根據你的後端路由調整
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(params),
            success: function (response) {
                location.reload();
            },
            error: function (xhr, status, error) {
                console.error("新增節點失敗：", error);
                alert("新增節點失敗，請稍後再試！");
            }
        });
    }
    
    function select_node(event, name, id){
        node_id = id ;
        $(event.target).blur();
        $("#displaySelected").text(name);
        const modalEl = document.getElementById('panelModal');
        const modal = bootstrap.Modal.getInstance(modalEl);
        if (modal) {
            modal.hide();
        }
    }
    
    function del_node(id){
        const params = {
            id: id
        };
        $.ajax({
            url: "/api/v1/node/del", // 根據你的後端路由調整
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(params),
            success: function (response) {
                location.reload();
            },
            error: function (xhr, status, error) {
                console.error("刪除節點失敗：", error);
                alert("刪除節點失敗，請稍後再試！");
            }
        });
    }
</script>
{{end}}