{{template "share" .}}

{{define "css"}}
<style>
    /* ------------------------------------------- */
    /* 主介面 - 文字顯示區樣式 */
    /* ------------------------------------------- */
    #displaySelected {
        border: 1px solid #ced4da;
        padding: .375rem .75rem;
        background-color: #e9ecef;
        /* 淺灰色背景 */
        min-width: 150px;
        border-radius: .25rem;
        color: #495057;
        font-weight: bold;
        flex-shrink: 0;
    }

    /* 確保 Modal 內容區有足夠的內距 */
    .modal-body {
        padding: 1.5rem;
    }
</style>
{{end}}

{{ define "category" }}
<ul class="list-group">
    {{ range . }}
    <li class="list-group-item">
        <div class="d-flex justify-content-between align-items-center">
            <span>
                {{ if .Children }}
                    <span data-bs-toggle="collapse" data-bs-target="#node-{{.NodeID}}" style="cursor:pointer;">
                        ⊞ {{ .PathName }}
                    </span>
                {{ else }}
                    ⊟ {{ .PathName }}
                {{ end }}
            </span>
            <button class="btn btn-sm btn-outline-danger" onclick="del_node('{{.NodeID}}')">刪除</button>
        </div>

        {{ if .Children }}
        <div class="collapse show mt-2 ms-3" id="node-{{.NodeID}}">
            {{ template "category" .Children }}
        </div>
        {{ end }}
    </li>
    {{ end }}
</ul>
{{ end }}

{{define "content"}}
<div class="mb-3">
    <div class="d-flex align-items-center gap-2 mb-4">
        <button type="button" class="btn btn-outline-primary flex-shrink-0" data-bs-toggle="modal" data-bs-target="#nodeModal">挑選父節點</button>
        <span id="displaySelected">尚未挑選父節點</span> <input type="text" class="form-control" id="mainTextInput" placeholder="輸入節點名稱">
        <button type="button" class="btn btn-success flex-shrink-0" onclick="add_node();">增加節點</button>
    </div>
</div>
<div class="mb-3">
    {{ template "category" .List }}
</div>
<div class="modal fade" id="nodeModal" tabindex="-1" aria-hidden="true" onclick="onBlur(event)">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">請選擇節點</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex flex-wrap gap-2">
                    <button type="button" class="btn btn-outline-info" onclick="select_node('{{.RootID}}', 'Root')">Root</button>
                    {{range .NodeMap}}
                    <button class="btn btn-outline-info" onclick="select_node('{{.NodeID}}', '{{.PathName}}')">{{.Path}}</button>
                    {{end}}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="onBlur(event)">關閉 Panel</button>
            </div>
        </div>
    </div>
</div>
{{end}}

{{define "js"}}
<script>
    function onBlur(event){
        $(event.target).blur();
    }

    var node_id ;
    function add_node(){
        if (node_id == undefined || node_id.length == 0) {
            alert("請先點擊「挑選父節點」按鈕，選擇一個父節點！");
            return;
        }
        const node_name = $("#mainTextInput").val();
        if (node_name.trim() === "") {
            alert("請輸入新的節點名稱！");
            return;
        }

        const params = {
            id: node_id,
            label: node_name
        };
        $.ajax({
            url: "/api/v1/node/add", // 根據你的後端路由調整
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(params),
            success: function (response) {
                location.reload();
            },
            error: function (xhr, status, error) {
                console.error("新增節點失敗：", error);
                alert("新增節點失敗，請稍後再試！");
            }
        });
    }
    
    function select_node(id, name){
        node_id = id ;
        $("#displaySelected").text(name);
        const modalEl = document.getElementById('nodeModal');
        const modal = bootstrap.Modal.getInstance(modalEl);
        if (modal) {
            modal.hide();
        }
    }
    
    function del_node(id){
        const params = {
            id: id
        };
        $.ajax({
            url: "/api/v1/node/del", // 根據你的後端路由調整
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(params),
            success: function (response) {
                if(response.Code != "OK"){
                    alert(response.Code)
                    return ;
                }
                location.reload();
            },
            error: function (xhr, status, error) {
                console.error("刪除節點失敗：", error);
                alert("刪除節點失敗，請稍後再試！");
            }
        });
    }
</script>
{{end}}