{{template "share" .}}

{{define "css"}}
<style>
    /* ------------------------------------------- */
    /* 主介面 - 文字顯示區樣式 */
    /* ------------------------------------------- */
    #displaySelected {
        border: 1px solid #ced4da;
        padding: .375rem .75rem;
        background-color: #e9ecef;
        /* 淺灰色背景 */
        min-width: 150px;
        border-radius: .25rem;
        color: #495057;
        font-weight: bold;
        flex-shrink: 0;
    }

    /* ------------------------------------------- */
    /* 彈跳 Panel - 120x120 大按鈕樣式 (使用 Flexbox 排版) */
    /* ------------------------------------------- */
    .big-square-button {
        width: 120px;
        /* 寬度 120px */
        height: 120px;
        /* 高度 120px */

        /* 使用 Flexbox 確保內容在按鈕內垂直和水平置中 */
        display: flex;
        align-items: center;
        justify-content: center;

        font-size: 1.1rem;
        font-weight: bold;
        text-align: center;
        white-space: normal;
        /* 允許文字換行 */
    }

    /* 確保 Modal 內容區有足夠的內距 */
    .modal-body {
        padding: 1.5rem;
    }
</style>
{{end}}

{{ define "list" }}
<button type="button" class="btn btn-outline-info big-square-button" onclick="select_node(event,'00000000-0000-0000-0000-000000000000')">Root</button>
{{ range . }}
<button type="button" class="btn btn-outline-info big-square-button" onclick="select_node(event,'{{.NodeID}}')">{{.PathName}}</button>
{{ end }}
{{end}}

{{ define "category" }}
<ul class="list-unstyled">
    {{ range . }}
    <li class="mb-3">
        <div class="card">
            <div class="card-body">
                <div id="node_list" class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="fw-bold">{{ .PathName }}</div>
                        {{/**
                        <div class="text-muted small"
                            data-bs-toggle="tooltip"
                            data-bs-placement="right"
                            title="Lft: {{ .LftIdx }}, Rft: {{ .RftIdx }}, ID: {{ .NodeID }}">
                            節點資訊
                        </div>
                        */}}
                    </div>
                    <button type="button"
                            class="btn btn-sm btn-outline-danger delete-node-btn"
                            data-id="{{ .NodeID }}"
                            title="刪除這個節點" onclick="del_node('{{.NodeID}}')">刪除
                    </button>
                </div>

                {{ if .Children }}
                <div class="mt-3 ms-4">
                    {{ template "category" .Children }}
                </div>
                {{ end }}
            </div>
        </div>
    </li>
    {{ end }}
</ul>
{{ end }}

{{define "content"}}
<div class="container mt-5">
    <h2>增加節點</h2>
    <div class="d-flex align-items-center gap-2 mb-4">
        <button type="button" class="btn btn-primary flex-shrink-0" data-bs-toggle="modal"
            data-bs-target="#panelModal">挑選父節點</button>
        <span id="displaySelected">尚未挑選父節點</span> <input type="text" class="form-control" id="mainTextInput"
            placeholder="輸入節點名稱">
        <button type="button" class="btn btn-success flex-shrink-0" onclick="add_node();">增加節點</button>
    </div>
</div>
<div class="container mt-5">
    {{ template "category" .List }}
</div>
<div class="modal fade" id="panelModal" tabindex="-1" aria-labelledby="panelModalLabel" aria-hidden="true" onclick="onBlur(event)">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="panelModalLabel">請選擇一個節點</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex flex-wrap gap-3 justify-content-center" id="modalButtonsContainer">
                    {{template "list" .Nodes}}
                </div>
                <hr class="mt-4">
                <p class="text-center text-muted">點擊上方的按鈕，會將其值填入主畫面的顯示區。</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="onBlur(event)">關閉 Panel</button>
            </div>
        </div>
    </div>
</div>
{{end}}

{{define "js"}}
<script>
    function onBlur(event){
        $(event.target).blur();
    }

    var node_id ;
    function add_node(){
        if (node_id == undefined || node_id.length == 0) {
            alert("請先點擊「挑選父節點」按鈕，選擇一個父節點！");
            return;
        }
        const node_name = $("#mainTextInput").val();
        if (node_name.trim() === "") {
            alert("請輸入新的節點名稱！");
            return;
        }

        const params = {
            id: node_id,
            label: node_name
        };
        $.ajax({
            url: "/api/v1/book/add/child", // 根據你的後端路由調整
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(params),
            success: function (response) {
                location.reload();
            },
            error: function (xhr, status, error) {
                console.error("新增節點失敗：", error);
                alert("新增節點失敗，請稍後再試！");
            }
        });
    }
    function select_node(event, id){
        node_id = id ;
        $(event.target).blur();
        $("#displaySelected").text(id);
        const modalEl = document.getElementById('panelModal');
        const modal = bootstrap.Modal.getInstance(modalEl);
        if (modal) {
            modal.hide();
        }
    }
    function del_node(id){
        const params = {
            id: id
        };
        $.ajax({
            url: "/api/v1/book/del/node", // 根據你的後端路由調整
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(params),
            success: function (response) {
                location.reload();
            },
            error: function (xhr, status, error) {
                console.error("刪除節點失敗：", error);
                alert("刪除節點失敗，請稍後再試！");
            }
        });
    }
</script>
{{end}}